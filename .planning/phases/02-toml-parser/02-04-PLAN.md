---
phase: 02-toml-parser
plan: 04
type: tdd
---

<objective>
Implement configuration merge logic for bill.toml + bill.local.toml with override rules.

Purpose: Allow users to override environment-specific settings (JDK path, Maven mirrors, compiler flags) in bill.local.toml without affecting team-shared bill.toml. Enforce strict boundaries on what can be overridden.
Output: ConfigMerger that combines team + user settings with validation.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./summary.md
./.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/CONVENTIONS.md
@.planning/phases/02-toml-parser/02-CONTEXT.md
@.planning/phases/02-toml-parser/02-03-SUMMARY.md
@toml/src/main/java/io/github/cowwoc/bill/toml/BillConfig.java
@toml/src/main/java/io/github/cowwoc/bill/toml/BillConfigParser.java
@toml/src/main/java/io/github/cowwoc/bill/toml/ConfigValidator.java

**Tech stack available:**
- BillConfigParser (parses TOML → BillConfig)
- ConfigValidator (validates semantics)
- requirements.java 12.0 for validation

**bill.local.toml design (CONTEXT.md):**
- User-specific overrides, gitignored
- Can override: JDK path, Maven repository URLs, compiler flags
- Cannot override: project.name, project.version (team-controlled for consistency)
- Cannot override: dependencies (team-controlled)

**Allowed overrides:**
- build.jdk_path (user-specific JDK location)
- build.compiler_args (user-specific compiler flags)
- repositories.maven_central_mirror (corporate Nexus, etc.)

**Forbidden overrides:**
- project.* (name, version, description - team settings)
- dependencies.* (dependency declarations - team settings)
</context>

<feature>
  <name>Merge bill.toml + bill.local.toml with override validation</name>
  <files>
    toml/src/main/java/io/github/cowwoc/bill/toml/LocalConfig.java,
    toml/src/main/java/io/github/cowwoc/bill/toml/ConfigMerger.java,
    toml/src/test/java/io/github/cowwoc/bill/toml/test/ConfigMergerTest.java
  </files>
  <behavior>
    Input: BillConfig (team settings), Optional<LocalConfig> (user overrides)
    Output: BillConfig (merged) OR exception if forbidden overrides attempted

    Merge rules:
    1. If no bill.local.toml exists → return bill.toml config as-is
    2. If bill.local.toml exists → merge allowed overrides
    3. If bill.local.toml tries to override forbidden fields → fail-fast with clear error

    Allowed overrides (bill.local.toml):
    - build.jdk_path
    - build.compiler_args
    - repositories.maven_central_mirror (new section)

    Forbidden overrides:
    - project.name, project.version, project.description
    - dependencies map
    - build.release (team-controlled JDK version - consistency requirement)

    Test cases:
    1. No local config → bill.toml unchanged
    2. Local config with jdk_path override → merged config has user's JDK path
    3. Local config with maven_central_mirror → merged config has mirror URL
    4. Local config tries to override project.name → Exception with error
    5. Local config tries to override project.version → Exception
    6. Local config tries to override dependencies → Exception
    7. Local config tries to override build.release → Exception (version stays team-controlled)
  </behavior>
  <implementation>
    RED phase:
    - Create LocalConfig record (build overrides, repository overrides)
    - Create ConfigMergerTest with test cases above
    - Tests use requirements.java for assertions
    - Example: requireThat(merged.build().jdkPath(), "jdkPath").isEqualTo(localOverride)
    - Tests will fail (ConfigMerger doesn't exist)

    GREEN phase:
    - Create ConfigMerger class
    - Implement merge(BillConfig team, Optional<LocalConfig> local) → BillConfig
    - Validate local config doesn't contain forbidden overrides (use requirements.java)
    - If validation fails, throw ConfigParseException with clear error
    - Create new BillConfig with merged build settings
    - Make all tests pass

    REFACTOR phase:
    - Extract validation logic if complex
    - Improve error messages (e.g., "bill.local.toml cannot override project.version - team setting")
    - Ensure tests still pass

    Note:
    - LocalConfig structure matches allowed overrides only (no project/dependencies fields)
    - Merge is type-safe - impossible to accidentally override forbidden fields
  </implementation>
</feature>

<verification>
All tests pass:
- mvn test -pl toml succeeds
- Allowed overrides merge correctly
- Forbidden overrides fail-fast with clear errors
- No local config works correctly
- Merge preserves team settings
</verification>

<success_criteria>
- Failing tests written and committed (RED)
- Implementation passes all tests (GREEN)
- Refactor complete if needed
- 2-3 atomic commits produced
- ConfigMerger enforces override boundaries
- Error messages clearly explain what can/cannot be overridden
- Phase 2 complete - TOML parsing fully functional
</success_criteria>

<output>
After completion, create `.planning/phases/02-toml-parser/02-04-SUMMARY.md` with:
- RED: What merge tests were written
- GREEN: How merge logic works and validates override boundaries
- REFACTOR: Any cleanup
- Commits: List of commits
- Phase completion note: bill.toml parser complete with error accumulation and local overrides
</output>
